---
title: "Wybory 2025"
format: 
   html:
     self-contained: true
---

```{r, include=FALSE}
library("skimr")
library("tidyverse")
library("scales")
library("ggeffects") 
library("mgcv")
library("car")
library("broom")
source("wczytaj_dane.R")

theme_set(ggpubr::theme_pubr(base_size = 18))
set.seed(42)
okabe <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00",
  "#CC79A7", "#999999", "#000000")
```

* Błędna interpretacja p-wartości jako prawdop. Nie uwzględnia prawdop. założenia, że stosuje się rozkład Benforda
* Nawrocki wygrywa w mniejszych komisjach, więc tam będą większe liczby (1000), czyli 1 przodu? Dla Dudy było tak samo. Ale w 1. turze było ok (bo mniej głosów i rzadziej 4-cyfrowy wynik)
* W ten sposób ciężko wykryć anomalie, raczej systematyczne błędy.
* Co więcej, ponieważ uzasadnia się, że te odbieganie jest m. in. przez dopisanie drugiego X, to w takim razie rozkład dla Trzaskowskiego nie powinien się zgadzać, bo przy liczbie głosów dla niego majstrowano

## Rozkład Benforda

W proteście powołano się między innymi na rozkład Benforda. Przy pewnych założeniach, rozkład częstości występowania pierwszych cyfr rozkłada się w pewien określony sposób: cyfra 1 występuje w około 30,1% przypadkach, cyfra 2 17,6% itd. Najważniejsza założenia: liczby mają wiele rzędów wielkości (setki, tysiące, miliony itd.) oraz powstają w pewnym naturalnym procesie (nie są sztucznie ograniczone). Przykłady to długości rzek, rozmiary populacji zamieszkujących jakiś teren czy stałe fizyczne.

## Liczba uprawnionych

Aby porównanie z rozkładem Benforda miało sens, trzeba najpierw uzasadnić (co jest trudne), że mamy do czynienia z liczbami, które powinny się w ten sposób rozkładać. Nie znajduję dobrego uzasadnienia w przypadku liczby głosów oddanych w każdej komisji na danego kandydata. Przeciwnie: wielkość komisji jest zaplanowany, tak aby nie była ani za duża, ani za mała. Liczba uprawnionych do głosowania to 55,9% przypadków liczba 3-cyfrowa, a w 40,5% liczba 4-cyfrowa, czyli w zasadzie mamy tylko dwa rzędy wielkości. Dodatkowo liczby 4-cyfrowe są w prawie 90% przypadków z przedziału 1000-1999, stąd można się spodziewać nadreprezentacji cyfry 1.

```{r}
#| include: false

wyb25 %>% 
  filter(Nupr_2 > 0) %>% 
  mutate(Liczba_cyfr = str_length(Nupr_2)) %>% 
  count(Liczba_cyfr) %>% 
  mutate(n / sum(n) * 100)

wyb25 %>% 
  filter(Nupr_2 > 0) %>% 
  mutate(Liczba_cyfr = str_length(Nupr_2)) %>% 
  filter(Liczba_cyfr == 4) %>% 
  summarise(mean(Nupr_2 < 2000))

wyb25 %>% 
  filter(N_2 > 0) %>% 
  pivot_longer(c(Nawrocki_2, Trzaskowski_2), names_to = "Kto", values_to = "N") %>% 
  mutate(Liczba_cyfr = str_length(N)) %>% 
  count(Liczba_cyfr) %>% 
  mutate(n / sum(n) * 100)
```

Na poniższym wykresie porównanie z rozkładem Benforda dla liczby uprawnionych. Zgodnie z przewidywaniami, rozkład ten nie ma tutaj zastosowania. Stąd moim zdaniem nie powinniśmy się spodziewać, że mając tylko dwóch kandydatów, liczba głosów --- które jest silnie skorelowana z liczbą uprawnionych --- już będzie miała taki rozkład (choć nie jest to wykluczone).

```{r}
wyb25 %>% 
  filter(Nupr_2 > 0) %>% 
  benford1("Nupr_2", "Liczba uprawnionych do głosowania, 2. tura 2025")
```

Istnieje rozszerzenie prawa Benforda na inne cyfry niż pierwsza. Poniżej porównanie drugiej cyfry dla liczby uprawnionych z rozkładem Benforda (jest on inny, niż w przypadku pierwsze cyfry).

```{r}
wyb25 %>% 
  filter(Nupr_2 > 0) %>% 
  benford2("Nupr_2", "Liczba uprawnionych do głosowania, 2. tura 2025", breaks = 0.02)
```

```{r}
#| include: false

n_dane <- wyb25 %>% 
  filter(Nupr_2 > 10) %>% 
  mutate(Nupr_2 = str_sub(Nupr_2, 2, 2)) %>% 
  count(Nupr_2) %>% 
  pull(n)
prop_benf <- benford_df$benford2 / sum(benford_df$benford2) # nie sumuje się do 1
chisq.test(x = n_dane, p = prop_benf)
```

Zgodność jest duża, choć nie idealna. Różnica między rozkładem Benforda a danymi jest istotna statystycznie (statystyka chi-kwadrat = 67,1).

## Liczba głosów

Mimo powyższych wątpliwości (które moim zdaniem są wystarczające), przejdźmy do analizy liczby głosów. Poniżej rozkład dla pierwszej cyfry dla Nawrockiego w 2. turze. To ten wykres pojawia się w proteście wyborczym.

```{r}
benford1(wyb25, "Nawrocki_2", "Liczba głosów, Nawrocki, 2. tura 2025", limit = 0.33)
```

Odstępstwo jest bardzo duże, co ma świadczyć o tym, że "manipulacje dotyczyły wyników tego kandydata" (cytat z protestu). Porównajmy z liczbą głosów na Trzaskowskiego.

```{r}
benford1(wyb25, "Trzaskowski_2", "Liczba głosów, Trzaskowski, 2. tura 2025", limit = 0.33)
```


```{r}
benford1(wyb20, "Duda_2", "Liczba głosów, Duda, 2. tura 2020", limit = 0.33)
```

Jeśli brak zgodności z rozkładem Benforda miałby świadczyć o manipulacjach, to wygląda na to, że w poprzednich wyborach były znacznie większe.


Natomiast w przypadku Trzaskowskiego również występują spore odchyłki.

Podsumowując, liczba głosów rzeczywiście znacznie odbiega od rozkładu Benforda. Ale powodem jest to, że w ogóle nie powinna się tak rozkładać.


```{r}
wyb25 %>% 
  pivot_longer(c(Nawrocki_2, Trzaskowski_2),
    names_to = "Kto", values_to = "N") %>% 
  mutate(Liczba_cyfr = str_length(N)) %>% 
  count(Kto, Liczba_cyfr) %>% 
  pivot_wider(names_from = Kto, values_from = n) %>% 
  mutate(across(c(Nawrocki_2, Trzaskowski_2), ~ . / sum(.) * 100))

wyb20 %>% 
  pivot_longer(c(Duda_2, Trzaskowski_2),
    names_to = "Kto", values_to = "N") %>% 
  mutate(Liczba_cyfr = str_length(N)) %>% 
  count(Kto, Liczba_cyfr) %>% 
  pivot_wider(names_from = Kto, values_from = n, values_fill = 0) %>% 
  mutate(across(c(Duda_2, Trzaskowski_2), ~ . / sum(.) * 100))
```





Oczywiście są mniejsze i później spróbujemy odpowiedzieć na pytanie dlaczego, póki co tylko zastanówmy się, w jaki sposób wyniki Nawrockiego miałyby oszukane


Dlaczego mniejsza odchyłka? Liczba 4-cyfr



```{r}
benford1(wyb25, "Trzaskowski_1", "Liczba głosów, Trzaskowski, 1. tura 2025", limit = 0.36)




benford1(wyb25, "Nawrocki_1", "Liczba głosów, Nawrocki, 1. tura 2025", limit = 0.36)


# A jak było w 2020?
benford1(wyb20, "Trzaskowski_1", "Liczba głosów, Trzaskowski, 1. tura 2020")
benford1(wyb20, "Trzaskowski_2", "Liczba głosów, Trzaskowski, 1. tura 2020")
benford1(wyb20, "Duda_1", "Liczba głosów, Duda, 1. tura 2020")



benford2(wyb25, "Trzaskowski_1", "Liczba głosów, Trzaskowski, 1. tura 2025")
benford2(wyb25, "Trzaskowski_2", "Liczba głosów, Trzaskowski, 2. tura 2025")
benford2(wyb25, "Nawrocki_1", "Liczba głosów, Nawrocki, 1. tura 2025")
benford2(wyb25, "Nawrocki_2", "Liczba głosów, Nawrocki, 2. tura 2025")
# A jak było w 2020?
benford2(wyb20, "Trzaskowski_1", "Liczba głosów, Trzaskowski, 1. tura 2020")
benford2(wyb20, "Trzaskowski_2", "Liczba głosów, Trzaskowski, 2. tura 2020")
benford2(wyb20, "Duda_1", "Liczba głosów, Duda, 1. tura 2020")
benford2(wyb20, "Duda_2", "Liczba głosów, Duda, 1. tura 2020")
```

Oszustwa w 2020 musiałyby być w większości komisji, żeby dostać aż tak duże odstępstwo. I właśnie tylko to można sprawdzić Benfordem, a nie anomalie.


Podział na wygraną

Czy Nawrocki wygrywa w mniejszych komisjach?

```{r}
ggplot(wyb25, aes(Nawrocki_2, ))
```


```{r}
wyb25 %>% 
  pivot_longer(c(Nawrocki_1, Nawrocki_2, Trzaskowski_1, Trzaskowski_2),
    names_to = "Kto", values_to = "N") %>% 
  mutate(Liczba_cyfr = str_length(N)) %>% 
  count(Kto, Liczba_cyfr) %>% 
  pivot_wider(names_from = Kto, values_from = n)

wyb20 %>% 
  pivot_longer(c(Duda_1, Duda_2, Trzaskowski_1, Trzaskowski_2),
    names_to = "Kto", values_to = "N") %>% 
  mutate(Liczba_cyfr = str_length(N)) %>% 
  count(Kto, Liczba_cyfr) %>% 
  pivot_wider(names_from = Kto, values_from = n)
```

Dlaczego zbyt mało jedynek dla Nawrockiego?

```{r}
wyb25 %>% 
  pivot_longer(c(Nawrocki_2, Trzaskowski_2),
    names_to = "Kto", values_to = "N") %>% 
  mutate(Liczba_cyfr = str_length(N)) %>% 
  filter(Liczba_cyfr == 4) %>% 
  mutate(Pierwsza_cyfra = str_sub(N, 1, 1)) %>% 
  count(Kto, Pierwsza_cyfra) %>% 
  pivot_wider(names_from = Kto, values_from = n, values_fill = 0)
```

```{r}
wyb25 %>% 
  filter(Nawrocki_2 > 0) %>% 
  mutate(Nawrocki_2 = str_sub(Nawrocki_2, 1, 1)) %>% 
  count(Nawrocki_2) %>% 
  left_join(benford_df, by = c("Nawrocki_2" = "dig")) %>% 
  mutate(Benford = round(sum(n) * benford1)) %>% 
  select(`Pierwsza cyfra` = Nawrocki_2, Dane = n, Benford) %>% 
  mutate(Różnica = Dane - Benford)
```

Czy jest problem też tam, gdzie Nawrocki przegrał?

```{r}
wyb25 %>% 
  filter(Nawrocki_2 < Trzaskowski_2) %>% 
  benford1("Nawrocki_2", "Liczba głosów, Nawrocki, 2. tura 2025")
```

```{r}
wyb25 %>% 
  filter(Nawrocki_2 > Trzaskowski_2) %>% 
  benford1("Nawrocki_2", "Liczba głosów, Nawrocki, 2. tura 2025")
```

```{r}
wyb25 %>% 
  filter(Nawrocki_2 < Trzaskowski_2) %>% 
  benford1("Trzaskowski_2", "Liczba głosów, Nawrocki, 2. tura 2025")
``` 

Najgorzej tam, gdzie Trzaskowski wygrał!

```{r}
wyb25 %>% 
  filter(Nawrocki_2 > Trzaskowski_2) %>% 
  benford1("Trzaskowski_2", "Liczba głosów, Nawrocki, 2. tura 2025")
``` 

